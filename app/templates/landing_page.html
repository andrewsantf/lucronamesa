{% extends "base.html" %}

{% block content %}
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<div class="landing-container-v2">
    <section class="hero-section text-center">
        <div class="container">
            <h1 class="hero-title">Sua lucratividade finalmente <span class="highlighted-word">visível.</span></h1>
            <p class="hero-subtitle">Gestão de custos eficiente com a planilha inteligente certa para o seu negócio.</p>
            <a href="{{ url_for('main.register', plan='trial') }}" class="btn btn-primary btn-lg shadow">Começar meu teste gratuito de 7 dias</a>
            <div class="social-proof-avatars">
                <div class="avatar-group">
                    <img src="{{ url_for('static', filename='img/avatars/avatar1.jpg') }}" alt="Avatar de usuário" class="avatar-image">
                    <img src="{{ url_for('static', filename='img/avatars/avatar2.jpg') }}" alt="Avatar de usuário" class="avatar-image">
                    <img src="{{ url_for('static', filename='img/avatars/avatar3.jpg') }}" alt="Avatar de usuário" class="avatar-image">
                    <img src="{{ url_for('static', filename='img/avatars/avatar4.jpg') }}" alt="Avatar de usuário" class="avatar-image">
                    <img src="{{ url_for('static', filename='img/avatars/avatar5.jpg') }}" alt="Avatar de usuário" class="avatar-image">
                </div>
                <p>Mais de <strong>150 empresas</strong> já estão otimizando seus custos conosco.</p>
            </div>
            <img src="{{ url_for('static', filename='img/dashboard_hero.png') }}" class="img-fluid hero-image shadow-lg mt-5" alt="Dashboard do LucroNaMesa">
        </div>
    </section>

    <section class="product-carousel-section text-center section-dark">
        <div class="container-fluid">
            <h2 class="section-title">Veja o que nossos clientes estão precificando.</h2>
        </div>
        <div class="swiper continuous-slider">
            <div class="swiper-wrapper">
                <div class="swiper-slide"><div class="product-card"><div class="product-card-image-wrapper"><img src="{{ url_for('static', filename='img/products/bolo_cenoura_chocolate.jpg') }}" alt="Bolo de Cenoura"></div><div class="product-card-body"><div><h4 class="product-card-title">Bolo de Cenoura com Chocolate</h4><p class="product-card-business">Confeitaria Delícias da Vó</p></div><div class="product-card-details"><span class="product-card-cost">Custo: R$ 18,50</span><span class="product-card-price">Venda: R$ 45,00</span></div></div></div></div>
                <div class="swiper-slide"><div class="product-card"><div class="product-card-image-wrapper"><img src="{{ url_for('static', filename='img/products/hamburger_artesanal.jpg') }}" alt="Hambúrguer Artesanal"></div><div class="product-card-body"><div><h4 class="product-card-title">Hambúrguer Artesanal</h4><p class="product-card-business">Burger do Chef</p></div><div class="product-card-details"><span class="product-card-cost">Custo: R$ 12,80</span><span class="product-card-price">Venda: R$ 32,50</span></div></div></div></div>
                <div class="swiper-slide"><div class="product-card"><div class="product-card-image-wrapper"><img src="{{ url_for('static', filename='img/products/brigadeiro_pistache.jpg') }}" alt="Brigadeiro de Pistache"></div><div class="product-card-body"><div><h4 class="product-card-title">Brigadeiro Gourmet de Pistache</h4><p class="product-card-business">Doces Encantados</p></div><div class="product-card-details"><span class="product-card-cost">Custo: R$ 1,80</span><span class="product-card-price">Venda: R$ 4,50</span></div></div></div></div>
                <div class="swiper-slide"><div class="product-card"><div class="product-card-image-wrapper"><img src="{{ url_for('static', filename='img/products/pao_de_queijo_recheado.jpg') }}" alt="Pão de Queijo Recheado"></div><div class="product-card-body"><div><h4 class="product-card-title">Pão de Queijo Recheado</h4><p class="product-card-business">Padaria Pão Quente</p></div><div class="product-card-details"><span class="product-card-cost">Custo: R$ 2,10</span><span class="product-card-price">Venda: R$ 6,00</span></div></div></div></div>
                <div class="swiper-slide"><div class="product-card"><div class="product-card-image-wrapper"><img src="{{ url_for('static', filename='img/products/torta_morango.jpg') }}" alt="Torta de Morango"></div><div class="product-card-body"><div><h4 class="product-card-title">Torta de Morango</h4><p class="product-card-business">Sabor e Arte Confeitaria</p></div><div class="product-card-details"><span class="product-card-cost">Custo: R$ 35,00</span><span class="product-card-price">Venda: R$ 95,00</span></div></div></div></div>
                <div class="swiper-slide"><div class="product-card"><div class="product-card-image-wrapper"><img src="{{ url_for('static', filename='img/products/coxinha_frango_requeijao.jpg') }}" alt="Coxinha de Frango"></div><div class="product-card-body"><div><h4 class="product-card-title">Coxinha de Frango com Requeijão</h4><p class="product-card-business">Salgados da Chef</p></div><div class="product-card-details"><span class="product-card-cost">Custo: R$ 1,10</span><span class="product-card-price">Venda: R$ 3,50</span></div></div></div></div>
            </div>
        </div>
    </section>

    <section class="before-after-section">
        <div class="container">
            <div class="row g-4 align-items-center">
                <div class="col-lg-5">
                    <h2 class="section-title">Chega de adivinhar.</h2>
                    <p class="section-subtitle">Precificar no "achismo" ou em planilhas complicadas coloca seu lucro em risco. Cada centavo conta.</p>
                    <ul class="list-unstyled before-list mt-4">
                        <li><i class="bi bi-x-circle text-danger me-2"></i>Incerteza se o preço de venda cobre os custos.</li>
                        <li><i class="bi bi-x-circle text-danger me-2"></i>Horas perdidas em cálculos manuais e complexos.</li>
                        <li><i class="bi bi-x-circle text-danger me-2"></i>Medo de reajustar preços quando um ingrediente sobe.</li>
                    </ul>
                </div>
                <div class="col-lg-7">
                    <div class="after-card">
                        <h3 class="h4"><i class="bi bi-check-circle-fill text-success me-2"></i>Tome decisões baseadas em dados.</h3>
                        <p>O LucroNaMesa automatiza o trabalho pesado, te dando a clareza necessária para focar no que importa: a qualidade do seu produto.</p>
                        <img src="{{ url_for('static', filename='img/reports_screenshot.png') }}" class="img-fluid rounded shadow-sm" alt="Relatórios do LucroNaMesa">
                        <p class="mt-3 fw-bold">Tenha controle total. Venda com confiança.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="features-section-v3 section-dark">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="section-title">Um assistente inteligente a trabalhar para si, 24/7.</h2>
                <p class="section-subtitle">O LucroNaMesa vai além de uma simples planilha, ele age para proteger o seu lucro.</p>
            </div>

            <div class="row feature-row align-items-center my-5 py-3">
                <div class="col-lg-6">
                    <div class="feature-text">
                        <span class="badge bg-warning text-dark mb-2">PROATIVO</span>
                        <h3>Seja notificado ANTES que o seu lucro diminua</h3>
                        <p>Um ingrediente subiu de preço? O LucroNaMesa deteta a alteração e envia-lhe um alerta automático, sugerindo a revisão das suas receitas. Proteja as suas margens sem esforço.</p>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="feature-image-container rounded shadow-lg">
                        <img src="{{ url_for('static', filename='img/feature_alertas.gif') }}" class="img-fluid feature-img" alt="Alertas automáticos de custo">
                    </div>
                </div>
            </div>

            <div class="row feature-row align-items-center my-5 py-3">
                <div class="col-lg-6 order-lg-2">
                    <div class="feature-text">
                        <span class="badge bg-info text-dark mb-2">INTELIGENTE</span>
                        <h3>Receba insights semanais no seu e-mail</h3>
                        <p>Toda segunda-feira, receba um resumo com as suas receitas mais lucrativas e os ingredientes com maior variação de preço. Mantenha-se a par do seu negócio, mesmo à distância.</p>
                    </div>
                </div>
                <div class="col-lg-6 order-lg-1">
                    <div class="feature-image-container rounded shadow-lg">
                        <img src="{{ url_for('static', filename='img/feature_relatorios.gif') }}" class="img-fluid feature-img" alt="Relatórios semanais por e-mail">
                    </div>
                </div>
            </div>

            <div class="row feature-row align-items-center my-5 py-3">
                <div class="col-lg-6">
                    <div class="feature-text">
                        <span class="badge bg-success text-white mb-2">RÁPIDO</span>
                        <h3>Diga adeus à digitação manual de compras</h3>
                        <p>Cole a chave da sua Nota Fiscal de compra e veja os ingredientes serem carregados automaticamente. Atualizar os seus custos nunca foi tão rápido e livre de erros.</p>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="feature-image-container rounded shadow-lg">
                        <img src="{{ url_for('static', filename='img/feature_nfe.gif') }}" class="img-fluid feature-img" alt="Importação de NF-e">
                    </div>
                </div>
            </div>

            <div class="row feature-row align-items-center my-5 py-3">
                 <div class="col-lg-6 order-lg-2">
                    <div class="feature-text">
                        <span class="badge bg-primary mb-2">CONVENIENTE</span>
                        <h3>O seu negócio na palma da sua mão</h3>
                        <p>Está na rua a fazer compras? Pergunte o custo ou preço de venda de qualquer receita diretamente no WhatsApp e obtenha uma resposta instantânea. O seu assistente financeiro está sempre consigo.</p>
                    </div>
                </div>
                 <div class="col-lg-6 order-lg-1">
                    <div class="feature-image-container phone-mockup mx-auto shadow-lg">
                        <img src="{{ url_for('static', filename='img/feature_chatbot.png') }}" class="img-fluid feature-img" alt="Chatbot no WhatsApp">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="interactive-demo-section">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="section-title">Experimente o poder do LucroNaMesa</h2>
            <p class="section-subtitle">Simule o fluxo real: cadastre ingredientes, monte sua receita e veja a mágica acontecer.</p>
        </div>
        <div class="demo-container-v3 shadow">
            <ul class="nav nav-tabs nav-fill" id="demoTabs" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="step1-tab" data-bs-toggle="tab" data-bs-target="#step1" type="button" role="tab" aria-controls="step1" aria-selected="true"><strong>Passo 1:</strong> Cadastrar Ingredientes</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="step2-tab" data-bs-toggle="tab" data-bs-target="#step2" type="button" role="tab" aria-controls="step2" aria-selected="false" disabled><strong>Passo 2:</strong> Montar Receita</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="step3-tab" data-bs-toggle="tab" data-bs-target="#step3" type="button" role="tab" aria-controls="step3" aria-selected="false" disabled><strong>Passo 3:</strong> Análise de Custos</button></li>
            </ul>
            <div class="tab-content p-4" id="demoTabsContent">
                <div class="tab-pane fade show active" id="step1" role="tabpanel" aria-labelledby="step1-tab">
                    <div class="row g-4"><div class="col-lg-6"><h4 class="mb-3">Adicionar Ingrediente</h4><form id="ingredient-form-demo"><div class="mb-3"><label for="ingName" class="form-label small">Nome do Ingrediente</label><input type="text" class="form-control" id="ingName" placeholder="Ex: Farinha de Trigo"></div><div class="row"><div class="col-md-4 mb-3"><label for="ingPrice" class="form-label small">Preço (R$)</label><input type="text" class="form-control" id="ingPrice" placeholder="5,50" inputmode="decimal"></div><div class="col-md-4 mb-3"><label for="ingQty" class="form-label small">Quantidade</label><input type="text" class="form-control" id="ingQty" placeholder="1000" inputmode="decimal"></div><div class="col-md-4 mb-3"><label for="ingUnit" class="form-label small">Unidade</label><select id="ingUnit" class="form-select"><option value="g">Grama (g)</option><option value="kg">Quilo (kg)</option><option value="ml">Mililitro (ml)</option><option value="l">Litro (l)</option><option value="un">Unidade (un)</option></select></div></div><button type="submit" class="btn btn-primary w-100">Adicionar Ingrediente</button></form></div><div class="col-lg-6"><h4 class="mb-3">Ingredientes Cadastrados</h4><div id="available-ingredients-list-demo" class="available-list-demo"><p class="text-muted text-center small p-2" id="ingredients-placeholder-demo">Nenhum ingrediente cadastrado.</p></div><button class="btn btn-primary w-100 mt-3" id="goto-step2" disabled>Próximo: Montar Receita <i class="bi bi-arrow-right"></i></button></div></div>
                </div>
                <div class="tab-pane fade" id="step2" role="tabpanel" aria-labelledby="step2-tab"><div class="mb-3"><label for="recipeNameDemo" class="form-label">Nome da sua Receita</label><input type="text" class="form-control" id="recipeNameDemo" placeholder="Ex: Bolo de Cenoura com Chocolate"></div><hr><p class="text-muted">Selecione os ingredientes da sua lista e defina a quantidade usada na receita.</p><div id="recipe-ingredients-list-demo"></div><button class="btn btn-primary w-100 mt-3" id="goto-step3" disabled>Ver Análise de Custos <i class="bi bi-graph-up"></i></button></div>
                <div class="tab-pane fade" id="step3" role="tabpanel" aria-labelledby="step3-tab"><h3 class="text-center mb-1" id="analysis-recipe-name">Análise da Receita</h3><p class="text-center text-muted mb-4">Ajuste a margem de lucro e veja o resultado em tempo real.</p><div class="row g-4"><div class="col-lg-6"><div class="mb-4"><label for="profit-margin-demo" class="form-label fw-bold">Margem de Lucro (%)</label><input type="number" id="profit-margin-demo" class="form-control form-control-lg text-center" value="150" inputmode="numeric"></div><div class="kpi-card-demo"><div class="kpi-content"><h5 class="kpi-title">Custo Total da Receita</h5><p class="kpi-value" id="total-cost-demo">R$ 0,00</p></div></div><div class="kpi-card-demo sale-price"><div class="kpi-content"><h5 class="kpi-title">Preço de Venda Sugerido</h5><p class="kpi-value" id="suggested-price-demo">R$ 0,00</p></div></div><div class="kpi-card-demo profit"><div class="kpi-content"><h5 class="kpi-title">Lucro Bruto</h5><p class="kpi-value" id="gross-profit-demo">R$ 0,00</p></div></div></div><div class="col-lg-6"><h5 class="text-center mb-3">Contribuição de Custo por Ingrediente</h5><div style="position: relative; height: 300px; width: 100%;"><canvas id="costBreakdownChartDemo"></canvas></div></div></div><button class="btn btn-outline-secondary w-100 mt-4" id="reset-demo"><i class="bi bi-arrow-clockwise"></i> Começar de Novo</button></div>
            </div>
        </div>
    </div>
</section>

    <section class="pricing-section section-dark">
        <div class="container">
            <div class="text-center mb-5"><h2 class="section-title">Um preço simples e justo para o seu crescimento.</h2></div>
            <div class="row justify-content-center"><div class="col-lg-5 col-md-6"><div class="pricing-card"><h3 class="plan-title">Mensal</h3><p class="plan-subtitle">Ideal para começar e validar.</p><div class="price-tag">R$ 59<span class="price-cents">,90</span><span class="price-period">/mês</span></div><ul class="feature-list list-unstyled"><li><i class="bi bi-check-circle-fill"></i> Ingredientes Ilimitados</li><li><i class="bi bi-check-circle-fill"></i> Receitas Ilimitadas</li><li><i class="bi bi-check-circle-fill"></i> Análise de Custo e Lucro</li><li><i class="bi bi-check-circle-fill"></i> Relatórios Inteligentes</li><li><i class="bi bi-check-circle-fill"></i> Suporte via E-mail</li></ul><a href="{{ url_for('main.register', plan='mensal') }}" class="btn btn-outline-primary w-100">Começar Agora</a></div></div><div class="col-lg-5 col-md-6"><div class="pricing-card highlighted"><div class="plan-badge">ECONOMIZE 2 MESES</div><h3 class="plan-title">Anual</h3><p class="plan-subtitle">O melhor custo-benefício para o seu negócio.</p><div class="price-tag">R$ 599<span class="price-cents">,90</span><span class="price-period">/ano</span></div><p class="text-muted text-center fw-bold">Equivale a R$ 49,99/mês</p><ul class="feature-list list-unstyled"><li><i class="bi bi-check-circle-fill"></i> Ingredientes Ilimitados</li><li><i class="bi bi-check-circle-fill"></i> Receitas Ilimitadas</li><li><i class="bi bi-check-circle-fill"></i> Análise de Custo e Lucro</li><li><i class="bi bi-check-circle-fill"></i> Relatórios Inteligentes</li><li><i class="bi bi-check-circle-fill"></i> Suporte via E-mail</li></ul><a href="{{ url_for('main.register', plan='anual') }}" class="btn btn-primary w-100">Quero Economizar</a></div></div></div>
        </div>
    </section>
    
    <section class="faq-section">
        <div class="container">
            <h2 class="section-title text-center mb-4">Perguntas Frequentes</h2>
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item"><h2 class="accordion-header" id="headingOne"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">O que é o LucroNaMesa?</button></h2><div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#faqAccordion"><div class="accordion-body">O LucroNaMesa é uma planilha de custos inteligente projetada para ajudar confeitarias, padarias e restaurantes a calcular o preço de custo e venda de seus produtos de forma fácil e precisa.</div></div></div>
                <div class="accordion-item"><h2 class="accordion-header" id="headingTwo"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">Quanto tempo leva para começar a usar?</button></h2><div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion"><div class="accordion-body">Você pode começar a usar o LucroNaMesa em poucos minutos! O cadastro de ingredientes e a criação de receitas são intuitivos e rápidos.</div></div></div>
                <div class="accordion-item"><h2 class="accordion-header" id="headingThree"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">Preciso de algum conhecimento técnico para usar?</button></h2><div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion"><div class="accordion-body">Não! O LucroNaMesa foi desenvolvido para ser fácil de usar, mesmo para quem não tem experiência com planilhas complexas ou cálculos de custos.</div></div></div>
                <div class="accordion-item"><h2 class="accordion-header" id="headingFour"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">Posso testar o LucroNaMesa antes de assinar?</button></h2><div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#faqAccordion"><div class="accordion-body">Sim! Oferecemos um teste gratuito de 7 dias para você experimentar todos os recursos do LucroNaMesa sem compromisso.</div></div></div>
                <div class="accordion-item"><h2 class="accordion-header" id="headingFive"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">Qual o valor do LucroNaMesa após o período de teste?</button></h2><div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#faqAccordion"><div class="accordion-body">Após o período de teste, você pode escolher entre o plano mensal de R$ 59,90 ou o plano anual com desconto de R$ 599,90 (equivalente a R$ 49,99/mês).</div></div></div>
            </div>
        </div>
    </section>

    <footer class="py-4 bg-white">
        <div class="container text-center"><span class="text-muted">© 2025 LucroNaMesa. Todos os direitos reservados.</span><span class="text-muted mx-2">|</span><a href="{{ url_for('main.privacy') }}">Política de Privacidade</a><span class="text-muted mx-2">|</span><a href="{{ url_for('main.terms') }}">Termos de Serviço</a></div>
    </footer>

    <a href="https://wa.me/556191081071?text=Olá!%20Gostaria%20de%20saber%20mais%20sobre%20o%20LucroNaMesa." class="whatsapp-float-button" target="_blank" rel="noopener noreferrer"><i class="bi bi-whatsapp"></i></a>
</div>

<script>
// SEU SCRIPT DA CALCULADORA E DO SWIPER (Mantido na íntegra)
document.addEventListener('DOMContentLoaded', function () {
    const ingredients = {};
    let recipe = {};
    let costChart = null;
    const ingredientForm = document.getElementById('ingredient-form-demo');
    const ingNameInput = document.getElementById('ingName');
    const availableList = document.getElementById('available-ingredients-list-demo');
    const ingredientsPlaceholder = document.getElementById('ingredients-placeholder-demo');
    const recipeList = document.getElementById('recipe-ingredients-list-demo');
    const profitMarginInput = document.getElementById('profit-margin-demo');
    const recipeNameInput = document.getElementById('recipeNameDemo');
    const analysisRecipeName = document.getElementById('analysis-recipe-name');
    const totalCostEl = document.getElementById('total-cost-demo');
    const suggestedPriceEl = document.getElementById('suggested-price-demo');
    const grossProfitEl = document.getElementById('gross-profit-demo');
    const step2TabBtn = document.getElementById('step2-tab');
    const step3TabBtn = document.getElementById('step3-tab');
    const gotoStep2Btn = document.getElementById('goto-step2');
    const gotoStep3Btn = document.getElementById('goto-step3');
    const resetBtn = document.getElementById('reset-demo');
    const normalizeUnit = (unit) => (unit === 'kg' ? 'g' : (unit === 'l' ? 'ml' : unit));
    const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;
    ingredientForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const name = ingNameInput.value.trim();
        const price = parseFloat(document.getElementById('ingPrice').value.replace(',', '.'));
        const qty = parseFloat(document.getElementById('ingQty').value.replace(',', '.'));
        const unit = document.getElementById('ingUnit').value;
        if (!name || isNaN(price) || isNaN(qty) || price <= 0 || qty <= 0) {
            alert('Por favor, preencha todos os campos com valores válidos.');
            return;
        }
        const baseQty = (unit === 'kg' || unit === 'l') ? qty * 1000 : qty;
        const baseCost = price / baseQty;
        const ingredientId = 'ing-' + Date.now();
        ingredients[ingredientId] = { name, baseCost, unit: normalizeUnit(unit) };
        renderAvailableIngredients();
        ingredientForm.reset();
        ingNameInput.focus();
    });

    function renderAvailableIngredients() {
        const hasIngredients = Object.keys(ingredients).length > 0;
        ingredientsPlaceholder.style.display = hasIngredients ? 'none' : 'block';
        gotoStep2Btn.disabled = !hasIngredients;
        availableList.innerHTML = '';
        if(hasIngredients) {
            for (const id in ingredients) {
                const ing = ingredients[id];
                const item = document.createElement('div');
                item.className = 'available-ingredient-item-demo';
                item.innerHTML = `<span class="fw-bold">${ing.name}</span><small class="text-muted">${formatCurrency(ing.baseCost * (ing.unit === 'g' || ing.unit === 'ml' ? 1000 : 1))}/${ing.unit === 'g' ? 'kg' : ing.unit === 'ml' ? 'l' : 'un'}</small>`;
                availableList.appendChild(item);
            }
        }
    }

    gotoStep2Btn.addEventListener('click', () => {
        step2TabBtn.disabled = false;
        new bootstrap.Tab(step2TabBtn).show();
        renderRecipeIngredients();
    });

    function renderRecipeIngredients() {
        recipeList.innerHTML = '';
        for (const id in ingredients) {
            const ing = ingredients[id];
            const item = document.createElement('div');
            item.className = 'input-group mb-3';
            item.innerHTML = `<div class="input-group-text"><input class="form-check-input mt-0 recipe-checkbox" type="checkbox" data-id="${id}" ${recipe[id] ? 'checked' : ''}></div><span class="input-group-text" style="width: 40%;">${ing.name}</span><input type="text" class="form-control recipe-quantity" placeholder="Quantidade" data-id="${id}" value="${recipe[id] ? recipe[id].quantity : ''}" inputmode="decimal" ${!recipe[id] ? 'disabled' : ''}><span class="input-group-text">${ing.unit}</span>`;
            recipeList.appendChild(item);
        }
        validateRecipe();
    }
    
    recipeList.addEventListener('change', function(e) {
        if (e.target.classList.contains('recipe-checkbox')) {
            const id = e.target.dataset.id;
            const quantityInput = e.target.closest('.input-group').querySelector('.recipe-quantity');
            if (e.target.checked) {
                recipe[id] = { quantity: '' };
                quantityInput.disabled = false;
                quantityInput.focus();
            } else {
                delete recipe[id];
                quantityInput.disabled = true;
                quantityInput.value = '';
            }
            validateRecipe();
        }
    });

    recipeList.addEventListener('input', function(e) {
        if (e.target.classList.contains('recipe-quantity')) {
            const id = e.target.dataset.id;
            if (recipe[id]) {
                recipe[id].quantity = e.target.value;
            }
            validateRecipe();
        }
    });
    
    function validateRecipe() {
        if(Object.keys(recipe).length === 0) {
            gotoStep3Btn.disabled = true;
            return;
        }
        for (const id in recipe) {
            const qty = parseFloat(String(recipe[id].quantity).replace(',', '.'));
            if(isNaN(qty) || qty <= 0) {
                gotoStep3Btn.disabled = true;
                return;
            }
        }
        gotoStep3Btn.disabled = false;
    }

    gotoStep3Btn.addEventListener('click', () => {
        step3TabBtn.disabled = false;
        new bootstrap.Tab(step3TabBtn).show();
        analysisRecipeName.textContent = recipeNameInput.value.trim() || 'Análise da Receita';
        updateAnalysis();
    });

    profitMarginInput.addEventListener('input', updateAnalysis);

    function updateAnalysis() {
        const labels = [];
        const data = [];
        let totalCost = 0;
        for (const id in recipe) {
            const ing = ingredients[id];
            const recipeIng = recipe[id];
            const quantity = parseFloat(String(recipeIng.quantity).replace(',', '.')) || 0;
            const cost = ing.baseCost * quantity;
            if(cost > 0){
                labels.push(ing.name);
                data.push(parseFloat(cost.toFixed(2)));
                totalCost += cost;
            }
        }
        const profitMargin = parseFloat(profitMarginInput.value) || 0;
        const suggestedPrice = totalCost * (1 + profitMargin / 100);
        const grossProfit = suggestedPrice - totalCost;
        totalCostEl.textContent = formatCurrency(totalCost);
        suggestedPriceEl.textContent = formatCurrency(suggestedPrice);
        grossProfitEl.textContent = formatCurrency(grossProfit);
        renderChart(labels, data);
    }
    
    function renderChart(labels, data) {
        const ctx = document.getElementById('costBreakdownChartDemo');
        if (costChart) { costChart.destroy(); }
        costChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Custo (R$)',
                    data: data,
                    backgroundColor: ['#18bc9c', '#2c3e50', '#f39c12', '#3498db', '#9b59b6', '#e74c3c', '#2ecc71', '#e67e22', '#1abc9c', '#d35400'],
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.raw || 0;
                                let total = context.chart.getDatasetMeta(0).total;
                                let percentage = (value / total * 100).toFixed(2) + '%';
                                return `${label}: ${formatCurrency(value)} (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    }

    resetBtn.addEventListener('click', () => {
        Object.keys(ingredients).forEach(key => delete ingredients[key]);
        recipe = {};
        ingredientForm.reset();
        recipeNameInput.value = '';
        profitMarginInput.value = '150';
        renderAvailableIngredients();
        step2TabBtn.disabled = true;
        step3TabBtn.disabled = true;
        new bootstrap.Tab(document.getElementById('step1-tab')).show();
    });

    new Swiper('.continuous-slider', {
        loop: true,
        slidesPerView: 'auto',
        freeMode: true,
        autoplay: { delay: 1, disableOnInteraction: false },
        speed: 5000,
    });
});
</script>
{% endblock %}