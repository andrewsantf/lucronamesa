{% extends "base.html" %}

{% block content %}
<div class="container mt-4" id="fiche-tecnica">
    
    <div class="fiche-header no-print">
        <div class="fiche-header-title">
            <h1 class="h2">Ficha Técnica</h1>
            <p class="text-muted mb-0 recipe-subtitle">Análise completa para: <strong>{{ recipe.name }}</strong></p>
        </div>
        <div class="fiche-header-actions">
            {# ATUALIZADO: Adicionada a classe 'action-btn-icon' #}
            <a href="{{ url_for('main.edit_recipe', recipe_id=recipe.id) }}" class="btn btn-sm btn-outline-secondary action-btn-icon" title="Editar Receita"><i class="bi bi-pencil"></i></a>
            <button onclick="window.print();" class="btn btn-sm btn-primary action-btn-icon" title="Imprimir / Exportar PDF"><i class="bi bi-printer"></i></button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-sm-6 col-lg-3 mb-3"><div class="card"><div class="card-body"><h5 class="kpi-title">Custo Total</h5><p class="kpi-value text-warning">R$ {{ "%.2f"|format(recipe.total_cost) }}</p></div></div></div>
        <div class="col-sm-6 col-lg-3 mb-3"><div class="card"><div class="card-body"><h5 class="kpi-title">Preço de Venda</h5><p class="kpi-value text-success">R$ {{ "%.2f"|format(recipe.sale_price) }}</p></div></div></div>
        <div class="col-sm-6 col-lg-3 mb-3"><div class="card"><div class="card-body"><h5 class="kpi-title">Lucro Bruto</h5><p class="kpi-value text-primary">R$ {{ "%.2f"|format(recipe.sale_price - recipe.total_cost) }}</p></div></div></div>
        <div class="col-sm-6 col-lg-3 mb-3"><div class="card"><div class="card-body"><h5 class="kpi-title">Margem</h5><p class="kpi-value">{{ "%.1f"|format(recipe.profit_margin) }}%</p></div></div></div>
    </div>
    
    <div class="row">
        <div class="col-lg-5 mb-4">
            <div class="card h-100">
                <div class="card-header"><h3 class="h5 mb-0">Contribuição de Custo (Gráfico)</h3></div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    {% if recipe.ingredients.all() %}
                        <div style="position: relative; height: 350px; width: 100%;">
                            <canvas id="costBreakdownChart"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted">Sem ingredientes para analisar.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-7 mb-4">
            <div class="card h-100">
                <div class="card-header"><h3 class="h5 mb-0">Composição de Custo (Detalhado)</h3></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-responsive-stack mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Ingrediente</th>
                                <th>Quantidade</th>
                                <th class="text-end">Custo (R$)</th>
                                <th class="text-end">Contribuição (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for item in recipe.ingredients %}
                            {% set item_cost = calculate_ingredient_cost_in_recipe(item.ingredient, item.quantity, item.unit_used) %}
                            <tr>
                                <td data-label="Ingrediente">{{ item.ingredient.name }}</td>
                                <td data-label="Quantidade">{{ item.quantity }} {{ item.unit_used }}</td>
                                <td data-label="Custo (R$)" class="text-end">R$ {{ "%.2f"|format(item_cost) }}</td>
                                <td data-label="Contribuição (%)" class="text-end">
                                    {% if recipe.total_cost > 0 %}
                                        {{ "%.1f"|format((item_cost / recipe.total_cost) * 100) }}%
                                    {% else %}
                                        0.0%
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header"><h3 class="h5 mb-0">Detalhes Técnicos</h3></div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Rendimento:</dt><dd class="col-sm-8">{{ recipe.yield_quantity }} {{ recipe.yield_unit }}</dd>
                        <dt class="col-sm-4">Custo por Porção:</dt><dd class="col-sm-8">R$ {{ "%.2f"|format(recipe.cost_per_serving) }}</dd>
                        <dt class="col-sm-4">Peso Total (Aprox.):</dt><dd class="col-sm-8">{{ (recipe.total_weight_g or 0)|round(0) }}g</dd>
                        <dt class="col-sm-4">Perda de Preparo:</dt><dd class="col-sm-8">{{ (recipe.loss_percentage or 0)|round(1) }}%</dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header"><h3 class="h5 mb-0">Modo de Preparo</h3></div>
                <div class="card-body" style="white-space: pre-wrap;">{{ recipe.preparation_steps or 'Nenhuma instrução de preparo foi adicionada.' }}</div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('costBreakdownChart');
    if (ctx) {
        const ingredientData = [
            {% for item in recipe.ingredients %}
                {
                    "label": "{{ item.ingredient.name }}",
                    "cost": {{ calculate_ingredient_cost_in_recipe(item.ingredient, item.quantity, item.unit_used)|round(2) }}
                },
            {% endfor %}
        ];

        const labels = ingredientData.map(item => item.label);
        const data = ingredientData.map(item => item.cost);

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Custo (R$)',
                    data: data,
                    backgroundColor: ['#18BC9C', '#2C3E50', '#F39C12', '#3498DB', '#9B59B6', '#E74C60', '#2ECC71', '#E67E22'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.raw || 0;
                                let total = context.chart.getDatasetMeta(0).total;
                                let percentage = (value / total * 100).toFixed(2) + '%';
                                return label + ': R$ ' + value.toFixed(2) + ' (' + percentage + ')';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}