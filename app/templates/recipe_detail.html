{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <div>
            <h1 class="h2">Análise da Receita</h1>
            <p class="text-muted mb-0">Detalhes de custo para: <strong>{{ recipe.name }}</strong></p>
        </div>
        <a href="{{ url_for('main.reports') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Voltar para Relatórios
        </a>
    </div>

    <div class="row mb-4">
        <div class="col-md-4"><div class="kpi-card"><div class="kpi-icon icon-avg-cost"><i class="bi bi-cash-coin"></i></div><div class="kpi-content"><h5 class="kpi-title">Custo Total</h5><p class="kpi-value">R$ {{ "%.2f"|format(recipe.total_cost) }}</p></div></div></div>
        <div class="col-md-4"><div class="kpi-card"><div class="kpi-icon icon-recipes"><i class="bi bi-tag-fill"></i></div><div class="kpi-content"><h5 class="kpi-title">Preço de Venda</h5><p class="kpi-value">R$ {{ "%.2f"|format(recipe.sale_price) }}</p></div></div></div>
        <div class="col-md-4"><div class="kpi-card"><div class="kpi-icon icon-ingredients"><i class="bi bi-graph-up-arrow"></i></div><div class="kpi-content"><h5 class="kpi-title">Lucro Bruto</h5><p class="kpi-value">R$ {{ "%.2f"|format(recipe.sale_price - recipe.total_cost) }}</p></div></div></div>
    </div>

    <div class="card">
        <div class="card-header bg-white">
            <h3 class="h5 mb-0">Contribuição de Custo por Ingrediente</h3>
        </div>
        <div class="card-body d-flex justify-content-center">
            {% if pie_chart_labels %}
                <div style="position: relative; height: 400px; width: 400px;">
                    <canvas id="costBreakdownChart"></canvas>
                </div>
            {% else %}
                <div class="empty-state">
                    <p>Não foi possível gerar a análise de ingredientes para esta receita.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('costBreakdownChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'pie', // Tipo: Pizza
            data: {
                labels: {{ pie_chart_labels|tojson }},
                datasets: [{
                    label: 'Custo (R$)',
                    data: {{ pie_chart_data|tojson }},
                    // Geraremos cores aleatórias para o gráfico de pizza
                    backgroundColor: [
                        'rgba(24, 188, 156, 0.7)',
                        'rgba(44, 62, 80, 0.7)',
                        'rgba(243, 156, 18, 0.7)',
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(155, 89, 182, 0.7)',
                        'rgba(231, 76, 60, 0.7)',
                        'rgba(46, 204, 113, 0.7)'
                    ],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.raw || 0;
                                let total = context.chart.getDatasetMeta(0).total;
                                let percentage = (value / total * 100).toFixed(2) + '%';
                                return label + ': R$ ' + value.toFixed(2) + ' (' + percentage + ')';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}